#!/bin/bash -e

photo_dir=${1?photo_dir required}
session_name=photo-upload-"$RANDOM"

# See https://github.com/koalaman/shellcheck/issues/562
# shellcheck disable=SC2140
escaped_photo_dir=${photo_dir/"'"/"'\\''"}

if [[ -d /run/systemd/system ]]; then
    limit_cmd=memlimit
else
    limit_cmd=
fi

if (( WOTOU_REMOTE )); then
    host=wotou-ext
else
    host=wotou
fi

extra_rclone_args=''
if (( SLOW )); then
    extra_rclone_args='--transfers 1'
fi

if (( NO_EXT )); then
    tmux new-session -d -s "$session_name" "echo NO_EXT was set"
else
    if (( LOCAL_EXT )); then
        tmux new-session -d -s "$session_name" \
            "$limit_cmd copy-photos-to-ext '$escaped_photo_dir'; echo Done; read"
    else
        tmux new-session -d -s "$session_name" \
            "$limit_cmd rsync -e 'ssh -T -c chacha20-poly1305@openssh.com -o Compression=no -x' --size-only -rvP --mkpath . $host:'/srv/samba/Photos/$escaped_photo_dir'; echo Done; read"
    fi
fi

tmux split-window -h -t "$session_name:1" \
    "while ! $limit_cmd rclone copy $extra_rclone_args -P . 'gs:chris-down-photos/chrisdown-photos/$escaped_photo_dir/'; do sleep 20; done; echo Done; read"

tmux attach -t "$session_name"
