#!/bin/bash -e

photo_dir=${1?photo_dir required}
session_name=photo-upload-"$RANDOM"

# See https://github.com/koalaman/shellcheck/issues/562
# shellcheck disable=SC2140
escaped_photo_dir=${photo_dir/"'"/"'\\''"}

limit_cmd="systemd-run --user -t -p MemoryMax=512M -p WorkingDirectory=\"$(pwd)\" --"

if (( WOTOU_REMOTE )); then
    host=wotou-ext
else
    host=wotou
fi

if (( LOCAL_EXT )); then
    tmux new-session -d -s "$session_name" \
        "$limit_cmd copy-photos-to-ext '$escaped_photo_dir'; echo Done; read"
else
    tmux new-session -d -s "$session_name" \
        "$limit_cmd rsync --size-only -rvP --mkpath . $host:'/srv/samba/Photos/$escaped_photo_dir'; echo Done; read"
fi

tmux split-window -h -t "$session_name:1" \
    "while ! $limit_cmd rclone copy -P . 'gs:chris-down-photos/chrisdown-photos/$escaped_photo_dir/'; do sleep 20; done; echo Done; read"

tmux attach -t "$session_name"
