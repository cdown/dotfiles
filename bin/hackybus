#!/bin/bash -e

# TfL, why the fuck do you require a static IP address to get API access for
# live buses? You just make people resort to this hacky bullshit and update it
# when you change your website.

extract_bus_times() {
    grep -F -e '<span class="visually-hidden"><span>' -e '<span class="live-board-eta">' |
        sed 'N;s/\n/ /' |
        sed 's#<span class="visually-hidden"><span>\([^<]*\)</span>.*\(Due\|[0-9]\+ mins\?\).*#\1: \2#' |
        sed 's/Due/0 mins/' | sort -n | uniq
}

declare -A bus_stops
bus_stops=(
    ["Essex House"]=https://tfl.gov.uk/bus/stop/490006641W/essex-house/
    ["Lavender Road"]=https://tfl.gov.uk/bus/stop/490011252E/lavender-road/
)

mapfile -d '' sorted_bus_stops < <(printf '%s\0' "${!bus_stops[@]}" | sort -z)

for stop in "${sorted_bus_stops[@]}"; do
    url="${bus_stops["$stop"]}"
    printf '%s:\n\n' "$stop"
    cat /tmp/q | extract_bus_times
    printf '\n'
done
