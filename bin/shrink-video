#!/bin/bash -ex

export LC_ALL=C

in=${1?}
out=${2:-"${in%.*}_SHRINK.mp4"}

: "${MAX_DIMENSION:=0}"
: "${VIDEO_CRF:=24}"
: "${PRESET:=faster}"
: "${X265:=1}"


extra_vf=''
if (( MAX_DIMENSION )); then
    extra_vf=scale=w="$MAX_DIMENSION":h="$MAX_DIMENSION":force_original_aspect_ratio=decrease', '
fi

if (( X265 )); then
    nice -n 19 \
        ffmpeg -y -i "$in" -c:v libx265 \
            -preset "${PRESET}" \
            -vf "${extra_vf}format=yuv420p" \
            -crf "$VIDEO_CRF" -acodec aac -b:a 192k "$out"
else
    nice -n 19 \
        ffmpeg -y -i "$in" -c:v libx264 -profile:v baseline \
            -preset "${PRESET}" \
            -vf "${extra_vf}format=yuv420p" \
            -crf "$VIDEO_CRF" -acodec aac -b:a 192k "$out"
fi

in_sz=$(stat -c%s "$in")
out_sz=$(stat -c%s "$out")
intolerance=1048576

if (( out_sz > (in_sz - intolerance) )); then
    printf '%s is not a significant improvement, restoring %s\n' "$out" "$in" >&2
    cp -- "$in" "$out"
fi
