#!/bin/bash -ex

device=${1?}
label=${2?}
cryptdev=ext
cryptdev_path=/dev/mapper/$cryptdev
pbkdf_kb=128000

if [[ $device == *[0-9] ]]; then
    printf '%s\n' 'Use the device itself, not a partition\n' >&2
    exit 1
fi

wipefs -a "$device"
sgdisk -Z "$device"
sgdisk -n 0:0:0 -c 1:"$label" "$device"

partprobe "$device"
sleep 5  # partprobe is async...

part="$device"1
unset device  # safety measure to make sure we don't introduce some bug that
	      # accidentally does something with the base device...

cryptsetup -y -v --pbkdf-memory "$pbkdf_kb" luksFormat "$part"
cryptsetup luksOpen --allow-discards "$part" "$cryptdev"

mkfs.ext4 -L "$label" "$cryptdev_path"
