#!/bin/bash -ex

device=${1?}
label=${2?}
cryptdev=ext
cryptdev_path=/dev/mapper/$cryptdev
pbkdf_kb=128000

if [[ $device == *[0-9] ]]; then
    printf '%s\n' 'Use the device itself, not a partition\n' >&2
    exit 1
fi

enable-usb-trim "$device"

wipefs -a "$device"
sgdisk -Z "$device"
sgdisk -n 0:0:0 -c 1:"$label" "$device"

cat > /sys/block/"${device##*/}"/uevent <<< change

sleep 5  # hold for reprobe


part="$device"1
unset device  # safety measure to make sure we don't introduce some bug that
	      # accidentally does something with the base device...

if ! [[ -e "$part" ]]; then
    printf '%s is missing\n' "$part" >&2
    exit 2
fi

cryptsetup -y -v --pbkdf-memory "$pbkdf_kb" luksFormat "$part"

temp_dir=$(mktemp -d)
temp=$temp_dir/header
cryptsetup luksHeaderBackup "$part" --header-backup-file "$temp"

cryptsetup luksOpen --allow-discards "$part" "$cryptdev"

mkfs.ext4 -L "$label" "$cryptdev_path"

mount_dir=$(mktemp -d)
mount "$cryptdev_path" "$mount_dir"
fstrim -v "$mount_dir"
umount "$mount_dir"

printf '\nHeader backup at %s\n' "$temp"
