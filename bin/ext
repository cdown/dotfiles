#!/bin/bash -e

case ${1?} in
    mount)
        mkdir -p /mnt/scratch{,-baduser}
        cryptsetup luksOpen -S 1 /dev/disk/by-partlabel/ext ext
        mount /dev/mapper/ext /mnt/scratch-baduser
        bindfs -u "$(id -u)" --create-for-user="$(stat -c %u /mnt/scratch-baduser)" /mnt/scratch-baduser /mnt/scratch
    ;;
    unmount)
        umount /mnt/scratch
        umount /mnt/scratch-baduser
        cryptsetup luksClose ext
    ;;
esac
