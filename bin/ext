#!/bin/bash -e

shopt -s nullglob

if ! (( UID )); then
    echo "run as non-root so we have the right uid" >&2
    exit 1
fi

parts=( /dev/disk/by-partlabel/ext-* )
num_parts=${#parts[@]}

if (( num_parts != 1 )); then
    printf 'Unexpected number of ext partitions: %s\n' "$num_parts" >&2
    exit 1
fi

part=${parts[0]}
label=${part##*/}

case ${1?} in
    mount)
        sudo mkdir -p /mnt/scratch{,-baduser}

        # This USB enclosure reports non-rotational, and TRIM isn't enabled by
        # default, sigh...
        part=$(readlink -f "$part")
        device=${part%[0-9]}
        sudo enable-usb-trim "$device"

        label=

        sudo cryptsetup luksOpen --allow-discards "$part" "$label"
        sudo mount /dev/mapper/"$label" /mnt/scratch-baduser
        sudo bindfs -u "$(id -u)" --create-for-user="$(stat -c %u /mnt/scratch-baduser)" /mnt/scratch-baduser /mnt/scratch
    ;;
    unmount)
        sudo umount /mnt/scratch
        sudo umount /mnt/scratch-baduser
        sudo cryptsetup luksClose "$label"
    ;;
    *)
        printf 'Unknown command: "%s"\n' "$1" >&2
        exit 1
    ;;
esac
