#!/bin/bash

action=${1?}

system_services=(atop)
user_services=(mpd mpdscribble clipmenud fcitx xbanish)

processes=(firefox spotify)

case $action in
    on)
        sudo powerdown
        sudo systemctl stop "${system_services[@]}"
        systemctl --user stop "${user_services[@]}"
        for process in "${processes[@]}"; do
            pkill -x "$process"
        done
        sudo intel-brightness 30

        # Takes a non-trivial amount of power according to powertop, see power
        # estimate when plugged in
        sudo ip link del docker0
    ;;
    off)
        sudo systemctl start "${system_services[@]}"
        systemctl --user start "${user_services[@]}"
        sudo intel-brightness 100
    ;;
    super)
        "$0" on
        tmux kill-server

        # TODO: support more than just iwlwifi
        mapfile -t wl_slots < <(
            sudo lshw -c network -businfo |
                awk '$2 ~ /^wl/ { print $1 }' | awk -F@ '{ print $2 }'
        )
        for dev in "${wl_slots[@]}"; do
            sudo tee <<< auto > /dev/null \
                /sys/bus/pci/devices/"$dev"/power/control
            sudo tee <<< "$dev" > /dev/null \
                /sys/bus/pci/drivers/iwlwifi/unbind
        done
    ;;
esac
