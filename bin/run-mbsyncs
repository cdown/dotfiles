#!/bin/bash

mbsync_job_ids=()

for config in ~/.config/mbsync/*; do
    config_name=${config##*/}
    timeout 60s -k=120s mbsync -c "$config" -a > "/tmp/mbsync-$config_name" 2>&1 &
    mbsync_job_ids+=("$!")
    NOTMUCH_CONFIG="$HOME/.config/notmuch/$config_name" notmuch new &
done

wait "${mbsync_job_ids[@]}"  # notmuch can keep running in the bg after
