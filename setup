#!/bin/bash

shopt -s dotglob extglob globstar nullglob

git clean -dffx
git submodule update --init --recursive

if [[ $0 == /* ]]; then
    location=${0%/*}
else
    location=$PWD/${0#./}
    location=${location%/*}
fi

rm -rf ~/.vim/bundle

for file in "$location"/**/*; do
    bare="${file#$location/}"

    case "$bare" in
        .git|.git/*|.gitignore|.gitmodules|setup|*/.gitkeep|README.md) continue ;;
    esac

    if [[ -d "$file" ]]; then
        if [[ -L ~/"$bare" ]]; then
            rm ~/"$bare"
        fi
        mkdir -m700 -p ~/"$bare"
    else
        ln -sfn "$file" ~/"$bare"
    fi
done

deleted=()
if [[ -f ~/.dfsha ]]; then
    mapfile -t deleted < <(git diff --name-status "$(<~/.dfsha)" HEAD | sed -n 's/^D[[:blank:]]//p')
fi

if (( "${#deleted[@]}" )); then
    printf 'Files removed since last setup:\n'
    printf '  ~/%q\n' "${deleted[@]}"
    printf '\nRemove files from home directory? '
    read -r delete_reply
    if [[ $delete_reply == [yY] ]]; then
        ( cd && rm -r "${deleted[@]}" )
    fi
fi

git rev-parse HEAD > ~/.dfsha
